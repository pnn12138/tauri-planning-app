# S1-6和S1-7实现计划（修正版）

## S1-6：加入日程的最小落地（仅 scheduled_start）

### 核心规则（硬规则）
- 统一采用**本地时间语义**：前端把 YYYY-MM-DD 09:00 当本地时间转成 ISO；后端按本地日期窗口过滤
- 只存 scheduled_start；不存 scheduled_end；不引入 estimate
- timeline 只展示 scheduled_start 落在今日的任务

### 实现步骤

#### S1-6a：修正日期转换逻辑（P0）
1. **检查并修正 toCreateTaskInputStep1 函数**：
   - 当前问题：函数将 `scheduledDate` 转换为 UTC 时间（末尾加 Z），但应该使用本地时间
   - 修正方案：将日期转换为本地时间的 ISO 格式，而非 UTC
   - 文件：`src/features/task-create/taskCreateModal.types.ts`

2. **验证转换结果**：
   - 输入：scheduledDate = "2024-01-15"
   - 期望输出：scheduled_start = "2024-01-15T09:00:00"（本地时间，不带 Z 后缀）

#### S1-6b：验证后端过滤逻辑（P0）
1. **检查后端 get_today_data 函数**：
   - 当前逻辑：使用 `today_start` 和 `today_end` 过滤任务，其中 `today` 是前端传入的 YYYY-MM-DD 格式
   - 验证：确保过滤条件是 `scheduled_start >= &today_start && start <= &today_end`，其中
     - today_start = "YYYY-MM-DD" + "T00:00:00"
     - today_end = "YYYY-MM-DD" + "T23:59:59"
   - 文件：`src-tauri/src/repo/planning_repo.rs`

2. **验证 today 参数来源**：
   - 检查前端如何生成 `today` 参数，确保使用本地日期
   - 文件：`src/features/planning/planning.store.ts` 或 `src/Home.tsx`

#### S1-6c：端到端验收测试（P0）
1. **测试场景 1：scheduled_start = 今天**
   - 操作：创建任务时选择今天的日期
   - 预期结果：任务出现在今天的 timeline 中

2. **测试场景 2：scheduled_start = 昨天**
   - 操作：创建任务时选择昨天的日期
   - 预期结果：任务不出现在今天的 timeline 中

3. **测试场景 3：scheduled_start = 明天**
   - 操作：创建任务时选择明天的日期
   - 预期结果：任务不出现在今天的 timeline 中

4. **测试场景 4：scheduled_start = 空**
   - 操作：创建任务时不选择日期
   - 预期结果：任务不出现在 timeline 中

5. **可选观察项**：
   - 任务在 timeline 中的小时分布（08:00-16:00 是 UI 展示策略，非核心要求）

## S1-7：Step1 回归验证

### 核心目标
- 确保 S1-6 的修改没有破坏已有 Step1 核心功能
- 验证新功能（scheduled_start + timeline）与现有功能的兼容性

### 验收用例

#### T2：新建任务持久化
- **操作**：创建任务 → 关闭应用 → 重新打开
- **预期结果**：任务仍存在，状态正确

#### T3：doing 重启恢复
- **操作**：将任务 A 设为 doing → 关闭应用 → 重新打开
- **预期结果**：任务 A 仍为 doing 状态

#### T4：doing 互斥
- **操作**：start A → start B
- **预期结果**：A 自动 stop，B 成为 currentDoing

#### T7：open_daily
- **操作 1**：第一次 open_daily
  - 预期结果：应创建文件并打开
- **操作 2**：第二次 open_daily
  - 预期结果：不重复创建（文件不被覆盖），仍可打开

#### T9：创建 + scheduled_start + timeline（新增）
- **操作**：创建带今天日期的任务 → 验证出现在 timeline → 重启应用 → 仍出现在 timeline
- **预期结果**：全流程正常，数据持久化正确

### 实现步骤
1. **运行现有测试**：
   - 若项目已有前端单测，运行 `npm run test` 或 `yarn test`
   - 确保所有测试通过，特别是与任务创建、状态管理相关的测试

2. **手动验证验收用例**：
   - 按照上述 T2-T9 用例逐一验证
   - 记录每个用例的执行结果

3. **集成测试**：
   - 测试完整的任务生命周期：创建 → 编辑 → 状态变更 → 完成
   - 验证错误处理机制仍正常工作

## 技术栈和工具
- **前端**：React + TypeScript
- **后端**：Rust + Tauri
- **测试**：手动测试 + 现有单元测试（若有）

## 预期结果
1. **S1-6 完成**：
   - 任务创建表单能正确设置本地时间的 scheduled_start
   - 当天的任务正确显示在 timeline 中
   - 时区处理一致，无语义漂移

2. **S1-7 完成**：
   - 所有回归用例通过
   - 新功能未破坏现有核心功能
   - 应用整体稳定性良好

## 风险评估
1. **低风险**：修改范围小，仅涉及日期转换和时区处理
2. **中风险**：时区处理不当可能导致任务显示异常
3. **低风险**：回归测试覆盖核心功能，确保不会引入新问题

## 依赖关系
- 依赖现有任务创建功能
- 依赖现有 Timeline 展示功能
- 依赖现有状态管理和 API 通信机制