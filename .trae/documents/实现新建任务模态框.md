# 实现新建任务模态框（改进版）

## 1. 数据契约对齐

### 1.1 定义最小字段协议

MVP创建任务最小字段：
- `title` (required): 任务标题
- `description` (optional): 任务描述
- `status` (required, default: "todo"): 任务状态
- `priority` (optional, default: "medium"): 优先级
- `tags` (optional, default: []): 标签列表
- `due_date` (optional): 截止日期（YYYY-MM-DD格式）

### 1.2 数据转换层

```typescript
// 前端UI状态
type TaskDraft = {
  title: string;
  description: string;
  status: TaskStatus;
  priority: 'high' | 'medium' | 'low';
  tags: string[];
  dueDate?: string;
  newTagInput: string;
};

// 后端IPC请求
type CreateTaskInput = {
  title: string;
  description?: string;
  status: TaskStatus;
  priority?: 'high' | 'medium' | 'low';
  tags?: string[];
  due_date?: string;
  estimate_min?: number;
};

// 转换函数
const toCreateTaskInput = (draft: TaskDraft): CreateTaskInput => ({
  title: draft.title,
  description: draft.description || undefined,
  status: draft.status,
  priority: draft.priority,
  tags: draft.tags.length > 0 ? draft.tags : undefined,
  due_date: draft.dueDate,
});
```

## 2. 组件拆分

### 2.1 创建独立组件

- **文件结构**:
  - `src/features/task-create/TaskCreateModal.tsx`
  - `src/features/task-create/taskCreateModal.css`
  - `src/features/task-create/taskCreateModal.types.ts`

### 2.2 组件接口

```typescript
interface TaskCreateModalProps {
  open: boolean;
  defaultStatus?: TaskStatus;
  onClose: () => void;
  onCreated: (taskId: string) => void;
}
```

## 3. 状态管理

### 3.1 单一状态对象

使用单个`draft`对象管理UI状态，避免分散的`useState`：

```typescript
const initialDraft: TaskDraft = {
  title: '',
  description: '',
  status: props.defaultStatus || 'todo',
  priority: 'medium',
  tags: [],
  dueDate: undefined,
  newTagInput: '',
};

const [draft, setDraft] = useState<TaskDraft>(initialDraft);

// 更新函数
const updateDraft = (patch: Partial<TaskDraft>) => {
  setDraft(prev => ({ ...prev, ...patch }));
};
```

## 4. 样式实现

### 4.1 主题变量（全局）

在`App.css`中添加主题变量：

```css
:root {
  --primary: #26bbd9;
  --priority-high: #F26C6C;
  --priority-med: #FFC74D;
  --priority-low: #4DAB4D;
  /* 其他主题变量 */
}
```

### 4.2 组件样式（局部）

在`taskCreateModal.css`中实现组件特定样式，避免污染全局CSS。

## 5. 功能实现

### 5.1 表单验证

- 仅强制验证：`title.trim().length > 0`
- 错误展示：标题下方一行红字

### 5.2 日期选择

- MVP阶段只实现日期选择（YYYY-MM-DD）
- 时间按钮先禁用

### 5.3 标签管理

- 支持添加/删除标签
- 标签输入回车添加

### 5.4 深色模式支持

- 使用CSS变量实现，避免重写样式
- 组件只消费主题变量

## 6. 实现步骤

### Step 0: 定义类型和转换函数
- 创建`taskCreateModal.types.ts`
- 定义`TaskDraft`、`CreateTaskInput`和转换函数

### Step 1: 创建组件框架
- 创建`TaskCreateModal.tsx`和`taskCreateModal.css`
- 实现组件基本结构和props

### Step 2: 实现状态管理
- 使用单一`draft`对象管理UI状态
- 实现`updateDraft`函数

### Step 3: 实现表单UI
- 按照设计文件实现表单字段
- 实现标签管理功能
- 禁用时间选择按钮

### Step 4: 实现样式
- 添加主题变量到`App.css`
- 实现组件样式
- 支持深色模式

### Step 5: 实现表单提交
- 实现表单验证
- 实现提交函数，调用转换函数
- 处理成功和失败情况

### Step 6: 更新Home组件
- 移除Home.tsx中的旧模态框
- 添加新组件的引用
- 实现打开/关闭和回调逻辑

## 7. 预期效果

- 现代化的新建任务模态框，与设计文件一致
- 独立的组件结构，便于维护和扩展
- 清晰的数据转换层，确保API兼容性
- 局部化的样式，避免CSS污染
- 良好的用户体验和视觉效果
- 支持深色模式