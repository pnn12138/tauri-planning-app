# Product Plan — Markdown Vault Editor (Revised)

## 1. 产品目标（Product Goal）

构建一个 **本地 Markdown Vault 编辑器**，用于浏览、编辑与预览本地 Markdown 文件集合（vault）。  
该产品面向**个人知识管理 / 技术笔记 / 项目文档**场景，强调：

- 本地优先（Local-first）
- 明确的安全边界（仅访问用户选择的 vault）
- 编辑与预览体验稳定、可控、可扩展

MVP 阶段目标是：**可靠完成「选目录 → 浏览文件 → 编辑 Markdown → 实时预览 → 本地保存」的完整闭环**。

---

## 2. MVP 核心功能需求

### 2.1 Vault 管理

- 用户可通过系统文件选择器选择一个本地目录作为 Vault
- Vault 一经选定：
  - 仅允许访问该目录及其子目录
  - 禁止访问 vault 之外的任意路径（包括 `../`、symlink 穿越）

---

### 2.2 文件树（File Explorer）

- 显示 vault 内的目录与 `.md` 文件
- 行为规则：
  - 目录优先，文件在后
  - 默认按名称排序
  - 支持目录展开 / 收起
  - 当前打开文件高亮
- 文件过滤：
  - 默认仅显示 `.md` 文件
  - 隐藏文件（`.` 开头）不显示
- 列表刷新：
  - 选择 vault 后定时自动扫描并刷新文件列表（无需手动 Rescan）

---

### 2.3 Markdown 编辑（MVP 必须支持）

#### 编辑器选型

- 使用 **CodeMirror 6** 作为 Markdown 编辑器内核
- 编辑器运行于前端 Renderer 进程
- 编辑内容为纯文本 Markdown（`.md`）

#### 编辑能力（MVP 范围）

- 基础文本编辑
  - 插入 / 删除 / 选择
  - 撤销 / 重做
- Markdown 语法支持
  - 标题、列表、代码块、引用、表格（GFM）
- 编辑器状态
  - 当前文件是否有未保存修改（dirty 状态）
  - 文件切换时给出未保存提示

> MVP 不要求 Vim / Emacs 模式  
> MVP 不要求协同编辑  
> MVP 不要求插件系统  

---

### 2.4 Markdown 预览（Live Preview）

- 编辑器旁提供 **实时 Markdown 预览区**
- 预览内容：
  - 与当前编辑文本实时同步
  - 支持 GitHub Flavored Markdown（GFM）
- 安全策略：
  - 默认禁用原始 HTML 渲染
  - 不执行脚本
- 代码块：
  - 支持语法高亮（无需支持所有语言）

> 编辑区与预览区为 **双栏模式**（Side-by-side）

---

### 2.5 文件读取与保存

- 文件打开：
  - 从后端按需读取 Markdown 文件内容
- 文件保存：
  - 手动保存（快捷键 / 按钮）
  - 覆盖写回原文件
- 保存保证：
  - 明确成功 / 失败反馈
  - 失败时不丢失编辑器内内容

---

## 3. 非功能性需求（Non-Functional）

### 3.1 安全性

- 后端仅接受 **相对路径**
- 所有路径在读取 / 写入前必须：
  1. 与 vault root 进行 join
  2. canonicalize（标准化）
  3. 校验最终路径仍位于 vault 内
- 禁止通过 symlink 访问 vault 外部路径

---

### 3.2 性能与稳定性

- 支持至少：
  - 数百个 Markdown 文件
  - 单文件体量 ≥ 几百 KB
- 文件切换：
  - 不出现旧请求覆盖新文件内容的竞态问题
- 编辑过程：
  - 输入延迟可控（CodeMirror 默认能力即可）

---

### 3.3 跨平台

- 支持 macOS / Windows / Linux
- 路径处理需考虑平台差异（分隔符、大小写）

---

## 4. 明确不在 MVP 中实现的内容

以下内容 **明确排除在 MVP 之外**，但不禁止未来扩展：

- 协同编辑 / 云同步
- Markdown 扩展插件市场（Phase 2+）
- 双向链接（wikilinks / graph view）
- 搜索索引、全文搜索
- 自定义主题系统（深色 / 浅色可延后）

> 插件系统不属于 MVP 验收范围，但属于 Phase 2+ 的平台演进目标。Phase 2 将引入插件 v0：仅命令/事件/受控文件读写/Markdown 后处理，插件在 WebWorker 中隔离运行，后端不执行插件代码。

---

## 5. 技术选型约束（Product-Level）

- 前端：
  - CodeMirror 6（Markdown 编辑）
  - Markdown 预览组件（与编辑器解耦）
- 后端（Electron 主进程）：
  - 仅负责文件系统访问与安全校验
  - 不解析 Markdown 语义

---

## 6. 成功标准（MVP Acceptance Criteria）

MVP 版本在以下场景下表现稳定：

1. 选择一个包含多个子目录与 Markdown 文件的 vault
2. 浏览文件树并打开任意文件
3. 在编辑器中修改内容，预览区实时更新
4. 保存文件并在本地文件系统中验证修改成功
5. 切换文件时，未保存内容有明确提示
6. 无法通过任何方式访问 vault 外路径

---

## 7. 产品演进方向（非实现承诺）

- 编辑器插件化（基于 CodeMirror Extension）
- 单栏 / 预览折叠模式
- 双向链接与知识图谱
- 搜索与标签系统
